---
# This is the ansible playbook for quick deployment of Ben's Bastion Host

- name: Install Basic Packages
  hosts: localhost
  become: yes
  vars:
    packages_to_install:
      - plocate
      - screen
      - python3
      - jq
      - postfix
      - sshuttle
      - sshpass
      - telnet
      - time
      - zip
      - unzip
      - wget
      - tar
      - sed
      - vim
      - curl
      - btop
      - apt-transport-https
      - ca-certificates
      - gnupg
      - software-properties-common
  tasks:
    - name: Update apt Cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      changed_when: false

    - name: Install Specified Packages
      ansible.builtin.apt:
        name: "{{ packages_to_install }}"
        state: present

- name: Install Google Cloud CLI
  hosts: localhost
  become: yes
  tasks:
    - name: Add Google Cloud APT Signing Key
      ansible.builtin.apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        keyring: /usr/share/keyrings/google-cloud.gpg
        state: present
      become: yes
      
    - name: Change Permission on GCP GPG Key
      ansible.builtin.file:
        path: /usr/share/keyrings/google-cloud.gpg
        mode: '0644'
      become: yes
        
    - name: Add Google Cloud APT repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/google-cloud.gpg] https://packages.cloud.google.com/apt cloud-sdk main"
        state: present
        filename: google-cloud-sdk

    - name: Install Google Cloud CLI
      ansible.builtin.apt:
        name: google-cloud-cli
        state: present
        update_cache: yes
  
- name: Install Terraform from HashiCorp APT Repository
  hosts: localhost
  become: yes # Requires sudo
  tasks:

    - name: 1. Install prerequisites
      ansible.builtin.apt:
        name: 
          - gpg
          - curl  # Make sure curl is installed
        state: present
        update_cache: yes

    - name: 2. Download and Dearmor HashiCorp GPG key in one step
      ansible.builtin.shell:
        # This command downloads the key with curl, pipes it to gpg --dearmor,
        # and saves the output directly to the final destination.
        cmd: curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
        
        # This makes the task idempotent (it won't run if the file already exists)
        creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg
        
        # We must use 'shell' to support the '|' (pipe)
        executable: /bin/bash 

    - name: 3. Add the HashiCorp repository
      ansible.builtin.apt_repository:
        filename: hashicorp
        repo: "deb [arch={{ ansible_architecture }} signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        state: present
        update_cache: no # We will update in the next step

    - name: 4. Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        
    - name: 5. Install Terraform
      ansible.builtin.apt:
        name: terraform
        state: present