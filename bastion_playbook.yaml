---
# This is the ansible playbook for quick deployment of Ben's Bastion Host

- name: Install Basic Packages
  hosts: localhost
  become: yes
  vars:
    packages_to_install:
      - plocate
      - screen
      - python3
      - jq
      - postfix
      - sshuttle
      - sshpass
      - telnet
      - time
      - zip
      - unzip
      - wget
      - tar
      - sed
      - vim
      - curl
      - btop
      - apt-transport-https
      - ca-certificates
      - gnupg
      - software-properties-common
  tasks:
    - name: Update apt Cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      changed_when: false

    - name: Install Specified Packages
      ansible.builtin.apt:
        name: "{{ packages_to_install }}"
        state: present

- name: Install Google Cloud CLI
  hosts: localhost
  become: yes
  tasks:
    - name: Add Google Cloud APT Signing Key
      ansible.builtin.apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        keyring: /usr/share/keyrings/google-cloud.gpg
        state: present
      become: yes
      
    - name: Change Permission on GCP GPG Key
      ansible.builtin.file:
        path: /usr/share/keyrings/google-cloud.gpg
        mode: '0644'
      become: yes
        
    - name: Add Google Cloud APT repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/google-cloud.gpg] https://packages.cloud.google.com/apt cloud-sdk main"
        state: present
        filename: google-cloud-sdk

    - name: Install Google Cloud CLI
      ansible.builtin.apt:
        name: google-cloud-cli
        state: present
        update_cache: yes
  
- name: Install Terraform from HashiCorp APT Repository
  hosts: all
  become: yes # Requires sudo
  tasks:

    - name: Install prerequisites
      ansible.builtin.apt:
        name: 
          - gpg
          - curl
        state: present
        update_cache: yes

    - name: Download and Dearmor HashiCorp GPG key
      ansible.builtin.shell:
        # Downloads and dearmors in one pipe
        cmd: curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
        # Makes task idempotent
        creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg
        executable: /bin/bash 

    # --- FIX: Get the correct architecture name ---
    - name: Get DPKG architecture (e.g., 'amd64')
      ansible.builtin.command:
        cmd: dpkg --print-architecture
      register: deb_architecture
      changed_when: false # This command doesn't make changes

    - name: Add the HashiCorp repository
      ansible.builtin.apt_repository:
        filename: hashicorp
        # Use the registered variable 'deb_architecture.stdout'
        # and 'ansible_distribution_release' (which correctly finds 'noble')
        repo: "deb [arch={{ deb_architecture.stdout }} signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        state: present
        update_cache: no # We will update in the next step

    # --- FIX: Force the cache update as a separate step ---
    - name: Update apt cache explicitly
      ansible.builtin.command:
        cmd: apt-get update
      changed_when: false # We expect 'apt-get update' to just run, not 'change' state
        
    - name: Install Terraform
      ansible.builtin.apt:
        name: terraform
        state: present